---
import Layout from "../layouts/Layout.astro";
import PostForm from "@components/PostForm";
import PostFeed from "@components/PostFeed";
import fetchJson from "@utils/fetchJson";
import TestFeed from "@components/TestFeed";
import { importJWK } from "jose";
import { verifyToken } from "~/server/users";
const origin = Astro.url.origin;

const authToken = Astro.cookies.get("authToken")?.value;
if (!authToken) return;

const secretKey = await importJWK({
  kty: "oct",
  k: import.meta.env.JWT_SECRET,
  alg: "HS256",
});

const { payload } = await verifyToken(authToken, secretKey);
if (!payload) return;

const currentUser = payload.username;
const result = await fetchJson(`${origin}/api/page?page=0`);
---

<Layout title="Balls">
  <main class="flex flex-row h-screen">
    <div class="w-full h-full">
      <div class="flex flex-col justify-evenly px-6 py-2 items-center h-full">
        <PostForm client:load />
      </div>
    </div>
    <div class="w-full h-screen overflow-x-clip overflow-y-scroll">
      <TestFeed initialFeed={result} currentUser={currentUser} client:load />
    </div>
  </main>
</Layout>

<style></style>
