---
import Layout from "../layouts/Layout.astro";
import PostForm from "@components/PostForm";
import PostFeed from "@components/PostFeed";
import fetchJson from "@utils/fetchJson";
import TestFeed from "@components/TestFeed";
import { importJWK } from "jose";
import { verifyToken } from "~/server/users";
import CurrentUser from "@components/CurrentUser.astro";
import HideOnMobile from "@components/blocks/HideOnMobile";
const origin = Astro.url.origin;

const authToken = Astro.cookies.get("authToken")?.value;
if (!authToken) return Astro.redirect("/404");

const secretKey = await importJWK({
  kty: "oct",
  k: import.meta.env.JWT_SECRET,
  alg: "HS256",
});

const { payload } = await verifyToken(authToken, secretKey);
if (!payload) return Astro.redirect("/404");

const currentUser = payload.username;
const result = await fetchJson(`${origin}/api/page?page=0`);
console.log(result);
if (!result) return Astro.redirect("/404");
---

<Layout title="Balls">
  <main class="flex flex-row h-screen">
    <HideOnMobile client:only="preact">
      <div class="w-full h-full px-2">
        <CurrentUser />
      </div>
      <div class="divider-horizontal bg-base-100"></div>
    </HideOnMobile>
    <div class="w-full h-screen overflow-x-clip overflow-y-scroll px-2 pt-2">
      <TestFeed initialFeed={result} currentUser={currentUser} client:load />
    </div>
    <HideOnMobile client:only="preact">
      <div class="divider-horizontal bg-base-100"></div>
      <div class="w-full h-full px-2">
        <div class="flex flex-col justify-evenly pr-2 py-2 items-center h-full">
          <PostForm client:visible />
        </div>
      </div>
    </HideOnMobile>
  </main>
</Layout>

<style></style>
