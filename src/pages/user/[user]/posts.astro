---
import fetchJson from "@utils/fetchJson";
import PostList from "@components/react-components/PostList";
import { GET } from "~/pages/api/users/loggedinuser";
import Userpage from "@layouts/Userpage.astro";
const { user } = Astro.params;

const origin = Astro.url.origin;
const body = {
  username: user,
};
const userPage = await fetchJson(`${origin}/api/users/getuser`, {
  method: "POST",
  body: JSON.stringify(body),
});
if (!userPage?.username) {
  return Astro.redirect("/404");
}

const response = await GET({ ...Astro, ResponseWithEncoding: Response });
if (!(response instanceof Response)) return Astro.redirect("/404");
const data = await response.json();
const currentUser = data.username;
---

<Userpage
  username={userPage.username}
  bio={userPage.description}
  role={userPage.role}
>
  <div class="w-full">
    <PostList
      role={userPage.role}
      feed={userPage.posts}
      currentUser={currentUser}
      client:visible
    />
    <div class="h-48"></div>
  </div>
</Userpage>
